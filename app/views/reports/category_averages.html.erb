<h1>Category Averages per Day</h1>

<%= form_with url: reports_category_averages_path, method: :get, local: true, class: "mb-3 d-flex gap-2 align-items-end" do |f| %>
  <div>
    <%= f.label :date, "Show for date" %>
    <%= f.date_field :date, value: params[:date], class: "form-control" %>
  </div>
  <div>
    <%= f.submit "Filter", class: "btn btn-primary" %>
    <%= link_to "Clear", reports_category_averages_path, class: "btn btn-secondary" %>
  </div>
<% end %>

<p class="text-muted">
  Categories: Monday = Frypan Warriors, Wednesday = Smart Lunch, Friday = Bathurst Buddies, Saturday/Sunday = Cafe. Tuesday/Thursday are excluded.
</p>

<% if @sorted_dates.blank? %>
  <div class="alert alert-info">No data for the selected period.</div>
<% else %>
  <% @sorted_dates.each do |date| %>
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong><%= date.strftime("%A, %d %B %Y") %></strong>
      </div>

      <div class="card-body">
        <% collective = @by_date_collective_average[date] %>
        <% if collective && collective[:avg_per_person] %>
          <div class="mb-3">
            <strong>Daily average time per person:</strong>
            <span><%= collective[:avg_per_person] %> min</span>
            <span class="text-muted">across <%= collective[:people_count] %> people</span>
          </div>
        <% end %>

        <% categories = @by_date_category_person[date] %>
        <% categories.keys.sort.each do |category_name| %>
          <% people_map = categories[category_name] %>

          <div class="mb-3" data-controller="toggle">
            <button class="btn btn-outline-secondary btn-sm" data-action="click->toggle#toggle">
              <span data-toggle-target="label">Show <%= category_name %></span>
              <span class="badge text-bg-light ms-2"><%= people_map.size %> people</span>
            </button>

            <div class="mt-3" data-toggle-target="panel" hidden>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Category</th>
                      <th>Person</th>
                      <th class="text-end">Average (min)</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% people_map.sort_by { |person, _| person.name.downcase }.each do |person, durations| %>
                      <% visits = durations.size %>
                      <% avg = visits.positive? ? (durations.sum.to_f / visits).round : 0 %>
                      <tr>
                        <td><%= category_name %></td>
                        <td><%= person.name %></td>
                        <td class="text-end"><%= avg %></td>
                        <td class="text-end"><%= visits %></td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
<% end %>
<%= link_to "Back to admin", admin_path, class: "btn btn-secondary mt-3" %>
